# Lotería de Navidad - Guía de Configuración de Supabase

Sigue estos pasos para configurar tu base de datos de Supabase y asegurar que la aplicación funcione correctamente. Este script está diseñado para que puedas ejecutarlo varias veces sin problemas; eliminará las tablas antiguas antes de crearlas para asegurar una configuración limpia.

## 1. Crear las Tablas y Funciones

Copia y pega **todo** el siguiente bloque de código en el Editor SQL de tu proyecto de Supabase y ejecútalo.

```sql
-- =================================================================
-- TABLA DE PERFILES (PROFILES)
-- =================================================================

-- Primero, eliminamos los objetos existentes para evitar errores si ya existen.
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();
DROP TABLE IF EXISTS public.profiles;

-- Creamos la tabla para los perfiles públicos de usuario.
CREATE TABLE public.profiles (
  id uuid NOT NULL REFERENCES auth.users ON DELETE CASCADE,
  username text UNIQUE,
  updated_at timestamp WITH TIME ZONE,
  PRIMARY KEY (id),
  UNIQUE(username),
  CONSTRAINT username_length CHECK (char_length(username) >= 3)
);

-- Configuramos la Seguridad a Nivel de Fila (RLS) para perfiles.
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public profiles are viewable by everyone." ON public.profiles
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile." ON public.profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile." ON public.profiles
  FOR UPDATE USING (auth.uid() = id);

-- Concedemos permisos a la API para que pueda leer la tabla.
GRANT SELECT ON TABLE public.profiles TO anon, authenticated;

-- Este trigger crea automáticamente un perfil cuando un nuevo usuario se registra.
CREATE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username)
  VALUES (new.id, new.raw_user_meta_data->>'username');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();


-- =================================================================
-- TABLA DE DÉCIMOS (TICKETS)
-- =================================================================

-- Eliminamos la tabla si ya existe.
DROP TABLE IF EXISTS public.tickets;

-- Creamos la tabla para los décimos de lotería.
CREATE TABLE public.tickets (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid REFERENCES auth.users NOT NULL,
  created_at timestamp WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  "number" CHARACTER VARYING(5) NOT NULL,
  participants integer NOT NULL DEFAULT 1,
  amount_played numeric NOT NULL DEFAULT 20,
  amount_per_participant numeric GENERATED ALWAYS AS (
    CASE WHEN participants > 0 THEN amount_played / participants ELSE 0 END
  ) STORED,
  prize_won numeric NOT NULL DEFAULT 0,
  shared_with text NULL
);

-- Configuramos la Seguridad a Nivel de Fila (RLS) para décimos.
ALTER TABLE public.tickets ENABLE ROW LEVEL SECURITY;

CREATE POLICY "allow_select_own_tickets"
  ON public.tickets FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "allow_insert_own_tickets"
  ON public.tickets FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "allow_update_own_tickets"
  ON public.tickets FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "allow_delete_own_tickets"
  ON public.tickets FOR DELETE
  USING (auth.uid() = user_id);

```

## 2. Claves de API

La aplicación está configurada para usar las claves `anon` de tu proyecto Supabase. No necesitas hacer nada más si has usado la URL y la clave `anon` proporcionadas en el `prompt`.

## 3. Mejoras Futuras Sugeridas

1.  **Compartir Social:** Permitir a los usuarios compartir un décimo específico con amigos a través de un enlace único, mostrando el número y los participantes.
2.  **Gestión de Grupos:** Crear grupos para familiares o compañeros de trabajo, donde todos puedan añadir décimos compartidos y ver el total invertido y los premios del grupo.
3.  **Notificaciones Push:** (Requiere un service worker y configuración de backend) Notificar a los usuarios cuando los resultados oficiales estén disponibles y sus décimos hayan sido comprobados.
4.  **Datos Históricos:** Permitir a los usuarios archivar sorteos de años anteriores para hacer un seguimiento de su suerte a lo largo del tiempo.
5.  **Gamificación:** Añadir insignias o logros por ciertos hitos (ej. "Primer Premio Ganado", "Súper Inversor", "Compartir es Vivir").